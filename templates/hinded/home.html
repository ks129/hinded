{% extends 'base.html' %}
{% load bootstrap_icons %}
{% load django_bootstrap5 %}

{% block title %}Avaleht{% endblock %}

{% block content %}
    {% include 'hinded/delete_hinne_confirm.html' %}
    {% include 'hinded/delete_isik_confirmation.html' %}
    {% include 'hinded/add_single_hinne.html' %}
    {% include 'hinded/edit_single_hinne.html' %}
    {% if user.is_authenticated %}
        <div style="overflow-x: auto;">
            <table class="table">
                <thead>
                    <tr>
                        <th scope="col">Õpilane</th>
                        {% for hinne in hinded %}
                            <th scope="col">
                                <div data-bs-toggle="tooltip" data-bs-html="true" data-bs-title="<b>Aine:</b> {{ hinne.aine|escape }} <br/> <b>Kirjeldus:</b> {{ hinne.kirjeldus|escape }}">{{ hinne.nimi }}</div>
                                <br/>
                                <a href="{% url 'update_hinne' pk=hinne.id %}" class="btn shadow-none" data-bs-toggle="tooltip" data-bs-title="Muuda">{% bs_icon 'pencil-square' color='blue' %}</a>
                                <br/>
                                <a href="{% url 'mass_add_hinded' pk=hinne.id %}" class="btn shadow-none" data-bs-toggle="tooltip" data-bs-title="Lisa hindeid hulgi">{% bs_icon 'person-fill' color='gray' %}</a>
                                <br/>
                                <span data-bs-toggle="modal" data-bs-target="#hinne-delete-modal-confirm">
                                    <button class="btn shadow-none delete-hinne" data-bs-toggle="tooltip" data-bs-title="Kustuta" data-delete-action="{% url 'delete_hinne' pk=hinne.id %}">
                                        {% bs_icon 'trash-fill' color='red' %}
                                    </button>
                                </span>
                            </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for isik, hinded in isikud.items %}
                        <tr>
                            <th scope="row">
                                {{ isik.0 }}
                                <br/>
                                <a href="{% url 'update_isik' pk=isik.1 %}" class="btn shadow-none">{% bs_icon 'pencil-square' color='blue' %}</a>
                                <span data-bs-toggle="modal" data-bs-target="#isik-delete-modal-confirm">
                                    <button class="btn shadow-none delete-isik" data-delete-action="{% url 'delete_isik' pk=isik.1 %}">
                                        {% bs_icon 'trash-fill' color='red' %}
                                    </button>
                                </span>
                            </th>
                            {% for hinne in hinded %}
                                <td style="width: 5%;" id="hinne-isik-{{ isik.1 }}-hinne-{{ hinne.hinde_id }}">
                                {% if not hinne.vaartus %}
                                    {% include 'hinded/add_cell.html' with isik_id=isik.1 isik_name=isik.0 hinde_id=hinne.hinde_id hinde_nimi=hinne.hinde_nimi %}
                                {% else %}
                                    {% with icon=hinne.vaartus|lower|add:"-square-fill" %}
                                        {% include 'hinded/hinne_cell.html' with markmed=hinne.markmed varv=hinne.varv icon=icon isik_id=isik.1 isik_name=isik.0 hinde_id=hinne.hinde_id hinde_nimi=hinne.hinde_nimi vaartus=hinne.vaartus %}
                                    {% endwith %}
                                {% endif %}
                                </td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p>Hinnete nägemiseks peate sisse logima.</p>
    {% endif %}
{% endblock %}

{% block scripts %}
    <script>
    $(document).on('click', '.delete-hinne', function() {
        document.getElementById('delete-hinne-form').action = $(this).data('deleteAction');
    });

    $(document).on('click', '.delete-isik', function() {
        document.getElementById('delete-isik-form').action = $(this).data('deleteAction');
    });

    $(document).on('click', '.btn-single-hinne', function() {
        document.getElementById('hinne-hinne-name').innerHTML = $(this).data('hinneName');
        document.getElementById('hinne-isik-name').innerHTML = $(this).data('isikName');
        document.getElementById('isik-id').value = $(this).data('isikId');
        document.getElementById('hinne-id').value = $(this).data('hinneId');
        $("#hinne-dropdown").val('X');
        $("#hinne-markmed").val('');
    });

    $(document).on('click', '.hinne-cell-val', function() {
        $('#delete-single-hinne-btn')
            .attr('data-isik-id', $(this).data('isikId'))
            .attr('data-hinne-id', $(this).data('hinneId'));
        $('#edit-hinne-hinne-name').html($(this).data('hinneName'));
        $('#edit-hinne-isik-name').html($(this).data('isikName'));
        $('#edit-isik-id').val($(this).data('isikId'));
        $('#edit-hinne-id').val($(this).data('hinneId'));
        $('#edit-hinne-markmed').val($(this).data('markmed'));
        $('#edit-hinne-dropdown').val($(this).data('hinne'));
    });

    $(document).on('click', '#delete-single-hinne-btn', function() {
        $.ajax({
            type: 'POST',
            url: $(this).data('action'),
            data: {
                'hinne-id': $(this).attr('data-hinne-id'),
                'isik-id': $(this).attr('data-isik-id'),
            },
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            dataType: 'json',
            success: function(response) {
                $('#hinne-isik-' + response.isik + '-hinne-' + response.hinne).html(response.html);
                const modal = bootstrap.Modal.getInstance(document.getElementById('edit-single-hinne'));
                modal.hide();
            },
            error: function() {
                alert("Hinde eemaldamine ebaõnnestus.");
            }
        });
    });

    $('#edit-single-hinne-form').submit(function(e) {
        e.preventDefault();

        const data = $(this).serialize();

        $.ajax({
            type: 'POST',
            url: $(this).attr("action"),
            data: data,
            dataType: 'json',
            success: function(response) {
                $('#hinne-isik-' + response.isik + '-hinne-' + response.hinne).html(response.html);
                const tooltipElement = $('#hinne-isik-' + response.isik + '-hinne-' + response.hinne + ' > span > [data-bs-toggle="tooltip"]');
                new bootstrap.Tooltip(tooltipElement);
                const modal = bootstrap.Modal.getInstance(document.getElementById('edit-single-hinne'));
                modal.hide();
            },
            error: function() {
                alert("Viga hinde muutmisel.");
            }
        });
    });

    $('#add-single-hinne-form').submit(function(e) {
        e.preventDefault();
        const data = $(this).serialize();

        $.ajax({
            type: 'POST',
            url: $(this).attr("action"),
            data: data,
            dataType: 'json',
            success: function(response) {
                $('#hinne-isik-' + response.isik + '-hinne-' + response.hinne).html(response.html);
                const tooltipElement = $('#hinne-isik-' + response.isik + '-hinne-' + response.hinne + ' > span > [data-bs-toggle="tooltip"]');
                new bootstrap.Tooltip(tooltipElement);
                const modal = bootstrap.Modal.getInstance(document.getElementById('add-single-hinne'));
                modal.hide();
            },
            error: function() {
                alert("Viga hinde lisamisel.");
            }
        });
    });

    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
    </script>
{% endblock %}
